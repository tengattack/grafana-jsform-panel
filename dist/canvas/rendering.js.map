{"version":3,"sources":["../../src/canvas/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","timeRange","editor","context","console","log","timeSrv","$panel","find","updateJsonSchema","events","on","render","renderingCompleted","submit","onMouseDown","event","$","document","one","mouseUpHandler","onMouseUp","unbind","onMouseLeave","onMouseMove","range","destroy","$editor","jsonSchema","JSON","parse","e","html","uploadHandler","eval","JSONEditor","defaults","callbacks","upload","disable_collapse","disable_edit_json","disable_properties","schema","$errmsg","hide","errors","validate","length","optShowErrors","options","show_errors","setOption","root","showValidationErrors","submitConfirmMsg","window","confirm","$submitBtn","prop","getValue","ajaxOpts","method","url","formActionUrl","dataType","success","res","message","ajaxSuccessPath","_","get","stringify","css","text","show","refreshOnSuccess","refreshDashboard","error","xhr","ajaxOptions","thrownError","responseText","status","ajaxFailurePath","formContentType","contentType","ajaxCredentials","xhrFields","withCredentials","ajax","appEvents","contextSrv"],"mappings":"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","file":"rendering.js","sourcesContent":["\nimport _ from 'lodash';\nimport { appEvents, contextSrv } from 'app/core/core';\nimport $ from 'jquery';\n\nimport { JSONEditor } from '../libs/jsoneditor';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  let data, panel, timeRange, editor, context;\n\n  console.log('timeSrv', ctrl.timeSrv)\n\n  const $panel = elem.find('.jsform-panel');\n\n  updateJsonSchema();\n\n  ctrl.events.on('render', () => {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  ctrl.events.on('update-json-schema', () => {\n    updateJsonSchema();\n  });\n\n  ctrl.events.on('submit', () => {\n    submit();\n  });\n\n  function onMouseDown(event) {\n    if (!panel) { return; }\n\n    $(document).one('mouseup', mouseUpHandler);\n  }\n\n  function onMouseUp() {\n    $(document).unbind('mouseup', mouseUpHandler);\n    mouseUpHandler = null;\n  }\n\n  function onMouseLeave() {\n    if (!panel) { return; }\n  }\n\n  function onMouseMove(event) {\n    if (!panel) { return; }\n  }\n\n  function mouseUpHandler() {\n    onMouseUp();\n  }\n\n  function render() {\n    data = ctrl.data;\n    panel = ctrl.panel;\n    timeRange = ctrl.range;\n  }\n\n  function updateJsonSchema() {\n    if (editor) {\n      editor.destroy();\n      editor = null;\n    }\n\n    const $editor = $panel.find('.json-editor')\n    let jsonSchema\n    try {\n      jsonSchema = JSON.parse(ctrl.panel.jsonSchema)\n    } catch (e) {\n      // show errors\n      $editor.html('JSON schema syntax error')\n      return\n    }\n\n    let uploadHandler\n    if (ctrl.panel.uploadHandler) {\n      try {\n        uploadHandler = eval('(' + ctrl.panel.uploadHandler + ')')\n      } catch (e) {\n        $editor.html('Upload handler syntax error')\n        return\n      }\n      if (typeof uploadHandler !== 'object') {\n        $editor.html('Upload handler should be an object')\n        return\n      }\n    }\n    // Specify upload handler\n    JSONEditor.defaults.callbacks.upload = uploadHandler\n\n    $editor.html('')\n    editor = new JSONEditor($editor[0], {\n      disable_collapse: true,\n      disable_edit_json: true,\n      disable_properties: true,\n      schema: jsonSchema,\n    })\n  }\n\n  function submit() {\n    if (!editor) { return; }\n\n    const $errmsg = $panel.find('.editor-submit .errmsg');\n    $errmsg.hide();\n\n    const errors = editor.validate();\n\n    if (errors.length) {\n      const optShowErrors = editor.options.show_errors;\n      // Would change the option and call `onChange`\n      editor.setOption('show_errors', 'always');\n      editor.root.showValidationErrors(errors);\n      editor.setOption('show_errors', optShowErrors);\n      return;\n    }\n\n    if (ctrl.panel.submitConfirmMsg) {\n      if (!window.confirm(ctrl.panel.submitConfirmMsg)) {\n        return;\n      }\n    }\n\n    const $submitBtn = $panel.find('.editor-submit button');\n    $submitBtn.prop('disabled', true);\n\n    const data = editor.getValue();\n    const ajaxOpts = {\n      method: 'POST',\n      url: ctrl.panel.formActionUrl,\n      data: data,\n      dataType: 'json',\n      success: function (res) {\n        let message = 'success';\n        if (typeof res === 'object') {\n          if (ctrl.panel.ajaxSuccessPath) {\n            message = _.get(res, ctrl.panel.ajaxSuccessPath)\n          } else {\n            message = JSON.stringify(res)\n          }\n        } else if (typeof res === 'string') {\n          message = res\n        }\n        $errmsg\n          .css('color', 'green')\n          .text(message)\n          .show();\n        $submitBtn.prop('disabled', false);\n        if (ctrl.panel.refreshOnSuccess) {\n          ctrl.timeSrv.refreshDashboard()\n        }\n      },\n      error: function (xhr, ajaxOptions, thrownError) {\n        let message = 'error';\n        if (!xhr.responseText) {\n          message = 'Error: ' + xhr.status\n        } else {\n          let res\n          try {\n            res = JSON.parse(xhr.responseText)\n          } catch (e) {\n            // PASS\n          }\n          if (typeof res === 'object') {\n            if (ctrl.panel.ajaxFailurePath) {\n              message = _.get(res, ctrl.panel.ajaxFailurePath)\n            } else {\n              message = JSON.stringify(res)\n            }\n          } else if (typeof res === 'string') {\n            message = res\n          } else {\n            message = xhr.responseText\n          }\n        }\n        $errmsg\n          .css('color', 'red')\n          .text(message)\n          .show();\n        $submitBtn.prop('disabled', false);\n      },\n    };\n    if (ctrl.panel.formContentType === 'json') {\n      ajaxOpts.data = JSON.stringify(data);\n      ajaxOpts.contentType = 'application/json; charset=utf-8';\n    }\n    if (ctrl.panel.ajaxCredentials) {\n      ajaxOpts.xhrFields = {\n        withCredentials: true,\n      };\n    }\n    $.ajax(ajaxOpts);\n  }\n\n  $panel.on('mousedown', onMouseDown);\n  $panel.on('mousemove', onMouseMove);\n  $panel.on('mouseleave', onMouseLeave);\n}\n"]}